<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="'X-UA-Compatible" content="IE-edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="MainClient.css" /> 
    <!--script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous"-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css">

    <title>Software License Management</title>
</head>
<body style="background-color: #f7ecda;">
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg" style="background-color: #e6c670; margin-bottom: 50px;">
      <div class="container-fluid">
        <a class="navbar-brand" href="home.html">Home</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="browse.html">Browse</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="Provider.html">Licenses</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="MainClient.html">Account</a>
            </li>
          </ul>
          <ul class="d-flex navbar-nav mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link" href="login.html">Log In</a>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <!--End of navbar-->
    <div class="header">
        <h1>My Licenses</h1>
        <a href="ClientInfo.html" id="profileButton"><i class="fas fa-user-circle"></i></a>
    </div>
    <div class="container contain">
      <h2>Your Licenses</h2>
      <table>
          <thead>
              <tr>
                  <th>Serial Number</th>
                  <th>Software Name</th>
                  <th>Purchase Date</th>
                  <th>Expiry Date</th>
                  <th>Action</th>
                  <th>Delete</th>
              </tr>
          </thead>
          <tbody>
          </tbody>
      </table>
      <div>
        <a href="browse.html" class="btn btn-outline-secondary ">Purchase new Licence</a>
      </div>
  </div>
    <footer class="flex-shrink-0 py-4 bg-dark text-white-50" style="margin-top: 100px;position: absolute; bottom: 0; width: 100%; padding: 1rem;">
      <div class="container text-center">
        <small>Copyright &copy; Your Licenses</small>
      </div>
    </footer>

    <script>
      document.addEventListener('DOMContentLoaded', function () {
    // Assuming you have the accountID from the server-side logic
    var accountID = 6; // Replace with the actual accountID
    document.querySelector('table').addEventListener('click', function (event) {
    if (event.target.classList.contains('delete-icon')) {
        event.preventDefault();
        console.log("Delete clicked");
        var licenseID = event.target.getAttribute('data-license-id');
        if (confirm('Are you sure you want to delete this license?')) {
            fetch(`/deleteLicense?licenseID=${licenseID}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove the deleted license from the table
                    var row = event.target.closest('tr');
                    row.parentNode.removeChild(row);
                    console.log('License deleted successfully.');
                } else {
                    console.error('Failed to delete the license.');
                }
            })
            .catch(error => console.error('Error:', error));
        }
    }
});

document.querySelector('table').addEventListener('click', function (event) {
        if (event.target.classList.contains('renew-link')) {
            event.preventDefault();
            console.log("Renew clicked");

            var licenseID = event.target.getAttribute('data-license-id');

            // Use the fetch API to renew the license
            fetch(`/renewLicense?licenseID=${licenseID}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ licenseID: licenseID }), // Include licenseID in the request body
            })
            .then(response => {
                  if (!response.ok) {
                      throw new Error(`HTTP error! Status: ${response.status}`);
                  }
                  return response.json();
              })                
              .then(data => {
                console.log('Renew License Response:', data);
                    if (data.success) {
                        // Update the table or show a success message
                        console.log('License renewed successfully.');

                        // Optionally, you can update the expiry date in the UI
                        // by finding the corresponding row and updating the date cell
                        var row = event.target.closest('tr');
                        var expiryDateCell = row.querySelector('td:nth-child(4)'); // Adjust the index based on your table structure
                        expiryDateCell.textContent = data.newExpiryDate; // Assuming the server sends the updated expiry date
                    } else {
                        console.error('Failed to renew the license.');
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    });

  
      // Make a request to the server to get the user's licenses based on accountID
      fetch(`/getlicenses?accountID=${accountID}`)
          .then(response => response.json())
          .then(data => {
              console.log("Inside fetch"); // Add this line
              console.log(data)
              // Process the returned data (array of licenses)
              if (data) {
                  // Now you can use the licenses in your client-side logic
                  updateLicenseTable(data);
              }
          })
          .catch(error => console.error('Error:', error))
          .finally(() => console.log('After fetch')); // Add this line
  
          function updateLicenseTable(licenses) {

            var tableBody = document.querySelector('tbody');
            tableBody.innerHTML = '';

            licenses.forEach(license => {
              console.log('License:', license);

              var row = document.createElement('tr');
              row.innerHTML = `
                <td>${license.serialNum}</td>
                <td>${license.name}</td> <!-- Use the correct property name -->
                <td>${formatDate(license.purchaseDate)}</td>
                <td>${formatDate(license.expiryDate)}</td>
                <td><a href="#" class="link-secondary renew-link" data-license-id="${license.id}">Renew</a></td>
                <td><a href="#" class="delete-icon"><i class="fas fa-trash-alt"></i></a></td>
              `;

              tableBody.appendChild(row);
            });

            console.log('User Licenses:', licenses);
          }



function formatDate(dateString) {
    const options = { year: 'numeric', month: 'numeric', day: 'numeric' };
    return new Date(dateString).toLocaleDateString(undefined, options);
}
});

  </script> 
</body>
</html>
